- name: "Install and configure awscli, kubectl, create ns and deploy defender"
  hosts: "{{ target | default('nothing') }}"
  environment:
    AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
    AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
    AWS_DEFAULT_REGION: "{{ AWS_DEFAULT_REGION }}"
    EKS_CLUSTER_NAME: "{{ EKS_CLUSTER_NAME }}"
  vars:
    ansible_user: ubuntu
  become: true
  tasks:
    - name: Update apt repository
      ansible.builtin.command:
        cmd: sudo apt-get update
      changed_when: false

    - name: Install python3-pip
      ansible.builtin.command:
        cmd: sudo apt install python3-pip -y
      changed_when: false

    - name: Install jq
      ansible.builtin.command:
        cmd: sudo apt-get install -y jq
      changed_when: false

    - name: Install aws-cli
      ansible.builtin.command:
        cmd: sudo apt-get install -y awscli
      changed_when: false

    - name: Install MongoDB Pre-Requisites
      ansible.builtin.command:
        cmd: sudo apt-get install gnupg curl -y
      changed_when: false

    - name: Download MongoDB Public GPG Key
      ansible.builtin.command:
        cmd: curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc -o /tmp/server-8.0.asc
      changed_when: false

    - name: Convert MongoDB GPG Key to armored format
      ansible.builtin.command:
        cmd: gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor /tmp/server-8.0.asc

    - name: Create MongoDB List File
      ansible.builtin.command:
        cmd: echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
      changed_when: false

    - name: Validate MongoDB Repository
      ansible.builtin.command: sudo apt-get update
      changed_when: false

    - name: Retry MongoDB Installation
      ansible.builtin.shell: |
        sudo apt-get install -y mongodb-org && \
        sudo systemctl start mongod && \
        sudo systemctl enable mongod
      args:
        warn: false
      retries: 5
      delay: 10

    - name: Download kubectl Latest Version
      ansible.builtin.command:
        cmd: sudo curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      changed_when: false

    - name: Install kubectl
      ansible.builtin.command:
        cmd: sudo mv kubectl /usr/local/bin/kubectl

    - name: Set permissions for kubectl
      ansible.builtin.command:
        cmd: sudo chmod 0755 /usr/local/bin/kubectl

    - name: Install pre-requisites with pip3
      pip:
        name:
          - openshift
          - pyyaml
          - kubernetes

    - name: Create AWS directory if it does not exist
      ansible.builtin.file:
        path: .aws
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Set AWS Credentials
      template:
        src: templates/credentials.j2
        dest: .aws/credentials

    - name: Set AWS Config
      template:
        src: templates/config.j2
        dest: .aws/config

    - name: Set Kubeconfig for cluster
      ansible.builtin.command:
        cmd: aws eks update-kubeconfig --name "{{ EKS_CLUSTER_NAME }}"

    - name: Copy backup.sh to target machine
      ansible.builtin.copy:
        src: ./scripts/backup.sh
        dest: /tmp/backup.sh
        mode: '0755'

    - name: Install backup script on target machine
      ansible.builtin.command:
        cmd: sudo /tmp/backup.sh 2>&1 | tee /tmp/backup.log
